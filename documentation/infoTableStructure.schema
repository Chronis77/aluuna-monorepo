-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.conversation_continuity (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  conversation_id uuid NOT NULL,
  last_message_count integer NOT NULL DEFAULT 0,
  last_session_phase character varying NOT NULL DEFAULT 'start'::character varying,
  last_therapeutic_focus text,
  last_emotional_state character varying,
  last_timestamp timestamp with time zone NOT NULL DEFAULT now(),
  session_duration_minutes integer DEFAULT 0,
  is_resuming boolean DEFAULT false,
  continuity_context text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT conversation_continuity_pkey PRIMARY KEY (id),
  CONSTRAINT conversation_continuity_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.conversations(id),
  CONSTRAINT session_continuity_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.conversation_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  conversation_id uuid,
  created_at timestamp without time zone DEFAULT now(),
  input_type text,
  input_transcript text,
  gpt_response text,
  audio_response_url text,
  summary text,
  mood_at_time integer,
  flagged boolean DEFAULT false,
  tags ARRAY,
  CONSTRAINT conversation_messages_pkey PRIMARY KEY (id),
  CONSTRAINT sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT conversation_messages_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.conversations(id)
);
CREATE TABLE public.conversation_themes (
  conversation_id uuid NOT NULL,
  theme_id uuid NOT NULL,
  CONSTRAINT conversation_themes_pkey PRIMARY KEY (conversation_id, theme_id),
  CONSTRAINT session_themes_theme_id_fkey FOREIGN KEY (theme_id) REFERENCES public.themes(id),
  CONSTRAINT conversation_themes_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.conversations(id)
);
CREATE TABLE public.conversations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  started_at timestamp without time zone DEFAULT now(),
  ended_at timestamp without time zone,
  title text,
  context_summary text,
  mood_at_start integer,
  mood_at_end integer,
  context_json json,
  created_at timestamp without time zone,
  description text,
  CONSTRAINT conversations_pkey PRIMARY KEY (id),
  CONSTRAINT session_groups_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.crisis_flags (
  id uuid NOT NULL,
  user_id uuid,
  session_id uuid,
  flag_type text,
  triggered_at timestamp without time zone DEFAULT now(),
  reviewed boolean DEFAULT false,
  CONSTRAINT crisis_flags_pkey PRIMARY KEY (id),
  CONSTRAINT crisis_flags_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.conversation_messages(id),
  CONSTRAINT crisis_flags_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.daily_practice_logs (
  id uuid NOT NULL,
  user_id uuid,
  practice_id uuid,
  date date,
  mood_before integer,
  mood_after integer,
  reflection text,
  CONSTRAINT daily_practice_logs_pkey PRIMARY KEY (id),
  CONSTRAINT daily_practice_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT daily_practice_logs_practice_id_fkey FOREIGN KEY (practice_id) REFERENCES public.daily_practices(id)
);
CREATE TABLE public.daily_practices (
  id uuid NOT NULL,
  user_id uuid,
  date date DEFAULT CURRENT_DATE,
  source text,
  prompt_text text,
  created_at timestamp without time zone DEFAULT now(),
  completed_at timestamp without time zone,
  related_session_id uuid,
  is_suggested boolean DEFAULT false,
  is_pinned boolean DEFAULT false,
  CONSTRAINT daily_practices_pkey PRIMARY KEY (id),
  CONSTRAINT daily_practices_related_session_id_fkey FOREIGN KEY (related_session_id) REFERENCES public.conversation_messages(id),
  CONSTRAINT daily_practices_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.data_exports (
  id uuid NOT NULL,
  user_id uuid,
  requested_at timestamp without time zone,
  export_url text,
  status text DEFAULT 'pending'::text,
  CONSTRAINT data_exports_pkey PRIMARY KEY (id),
  CONSTRAINT data_exports_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.emotional_trends (
  id uuid NOT NULL,
  user_id uuid,
  recorded_at timestamp without time zone DEFAULT now(),
  mood_score integer CHECK (mood_score >= 1 AND mood_score <= 10),
  mood_label text,
  notes text,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT emotional_trends_pkey PRIMARY KEY (id),
  CONSTRAINT emotional_trends_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.feedback (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  raw_feedback text NOT NULL,
  ai_summary text,
  priority character varying CHECK (priority::text = ANY (ARRAY['low'::character varying, 'medium'::character varying, 'high'::character varying, 'critical'::character varying]::text[])),
  feedback_type character varying DEFAULT 'general'::character varying,
  device_info jsonb,
  app_version character varying,
  created_at timestamp with time zone DEFAULT now(),
  processed_at timestamp with time zone,
  status character varying DEFAULT 'pending'::character varying CHECK (status::text = ANY (ARRAY['pending'::character varying, 'processed'::character varying, 'resolved'::character varying, 'ignored'::character varying]::text[])),
  tags ARRAY,
  metadata jsonb,
  CONSTRAINT feedback_pkey PRIMARY KEY (id),
  CONSTRAINT feedback_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.feedback_log (
  id uuid NOT NULL,
  user_id uuid,
  session_id uuid,
  rating integer CHECK (rating >= 1 AND rating <= 5),
  comment text,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT feedback_log_pkey PRIMARY KEY (id),
  CONSTRAINT feedback_log_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.free_journal_entries (
  id uuid NOT NULL,
  user_id uuid,
  created_at timestamp without time zone DEFAULT now(),
  entry_text text,
  tags ARRAY,
  mood_score integer,
  CONSTRAINT free_journal_entries_pkey PRIMARY KEY (id),
  CONSTRAINT free_journal_entries_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.growth_milestones_log (
  id uuid NOT NULL,
  user_id uuid,
  milestone text,
  related_session_id uuid,
  date_achieved date,
  method text,
  CONSTRAINT growth_milestones_log_pkey PRIMARY KEY (id),
  CONSTRAINT growth_milestones_log_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.habit_streaks (
  id uuid NOT NULL,
  user_id uuid,
  habit_type text,
  current_streak integer,
  longest_streak integer,
  last_entry date,
  CONSTRAINT habit_streaks_pkey PRIMARY KEY (id),
  CONSTRAINT habit_streaks_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.inner_parts (
  id uuid NOT NULL,
  user_id uuid,
  name text,
  role text,
  tone text,
  description text,
  updated_at timestamp without time zone DEFAULT now(),
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT inner_parts_pkey PRIMARY KEY (id),
  CONSTRAINT inner_parts_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.insights (
  id uuid NOT NULL,
  user_id uuid,
  created_at timestamp without time zone DEFAULT now(),
  insight_text text,
  related_theme text,
  importance integer DEFAULT 5 CHECK (importance >= 1 AND importance <= 10),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT insights_pkey PRIMARY KEY (id),
  CONSTRAINT insights_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.mantras (
  id uuid NOT NULL,
  user_id uuid,
  text text,
  source text,
  created_at timestamp without time zone DEFAULT now(),
  is_favorite boolean DEFAULT false,
  tags ARRAY,
  is_pinned boolean DEFAULT false,
  CONSTRAINT mantras_pkey PRIMARY KEY (id),
  CONSTRAINT mantras_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.memory_profiles (
  id uuid NOT NULL,
  user_id uuid,
  spiritual_connection_level integer CHECK (spiritual_connection_level >= 1 AND spiritual_connection_level <= 10),
  personal_agency_level integer CHECK (personal_agency_level >= 1 AND personal_agency_level <= 10),
  boundaries_awareness integer CHECK (boundaries_awareness >= 1 AND boundaries_awareness <= 10),
  self_development_capacity integer CHECK (self_development_capacity >= 1 AND self_development_capacity <= 10),
  hard_truths_tolerance integer CHECK (hard_truths_tolerance >= 1 AND hard_truths_tolerance <= 10),
  awareness_level integer CHECK (awareness_level >= 1 AND awareness_level <= 10),
  suicidal_risk_level integer CHECK (suicidal_risk_level >= 0 AND suicidal_risk_level <= 3),
  updated_at timestamp without time zone DEFAULT now(),
  created_at timestamp without time zone DEFAULT now(),
  sleep_quality text,
  mood_score_initial integer,
  themes jsonb,
  people jsonb,
  coping_tools jsonb,
  goals jsonb,
  preferred_therapy_styles jsonb,
  preferred_tone jsonb,
  pattern_loops jsonb,
  shadow_themes jsonb,
  current_practices jsonb,
  regulation_strategies jsonb,
  dysregulating_factors jsonb,
  role_model_traits jsonb,
  growth_milestones jsonb,
  emotional_patterns jsonb,
  relationship_dynamics jsonb,
  growth_opportunities jsonb,
  risk_factors jsonb,
  strengths jsonb,
  mood_trends jsonb,
  emotional_states_initial jsonb,
  support_system jsonb,
  current_stressors jsonb,
  daily_habits jsonb,
  substance_use jsonb,
  stuck_points jsonb,
  summary jsonb,
  trauma_patterns jsonb,
  ancestral_issues jsonb,
  spiritual_path_notes jsonb,
  insight_notes jsonb,
  therapeutic_approach jsonb,
  motivation_for_joining jsonb,
  hopes_to_achieve jsonb,
  previous_therapy jsonb,
  therapy_type jsonb,
  therapy_duration jsonb,
  sleep_routine jsonb,
  suicidal_thoughts_initial jsonb,
  relationship_status jsonb,
  living_situation jsonb,
  biggest_challenge jsonb,
  biggest_obstacle jsonb,
  CONSTRAINT memory_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT memory_profiles_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.memory_snapshots (
  id uuid NOT NULL,
  user_id uuid,
  created_at timestamp without time zone DEFAULT now(),
  summary text,
  key_themes ARRAY,
  generated_by text DEFAULT 'gpt'::text,
  CONSTRAINT memory_snapshots_pkey PRIMARY KEY (id),
  CONSTRAINT memory_snapshots_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.onboarding_progress (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  onboarding_data jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT onboarding_progress_pkey PRIMARY KEY (id),
  CONSTRAINT onboarding_progress_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.prompt_logs (
  id uuid NOT NULL,
  user_id uuid,
  session_id uuid,
  prompt_text text,
  gpt_model text,
  response_text text,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT prompt_logs_pkey PRIMARY KEY (id),
  CONSTRAINT prompt_logs_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.conversation_messages(id),
  CONSTRAINT prompt_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.relationships (
  id uuid NOT NULL,
  user_id uuid,
  name text,
  role text,
  notes text,
  is_active boolean DEFAULT true,
  CONSTRAINT relationships_pkey PRIMARY KEY (id),
  CONSTRAINT relationships_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.themes (
  id uuid NOT NULL,
  name text UNIQUE,
  CONSTRAINT themes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_preferences (
  user_id uuid NOT NULL,
  show_text_response boolean DEFAULT true,
  play_audio_response boolean DEFAULT true,
  preferred_therapist_name text,
  daily_reminder_time time without time zone,
  timezone text,
  CONSTRAINT user_preferences_pkey PRIMARY KEY (user_id),
  CONSTRAINT user_preferences_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.users (
  id uuid NOT NULL,
  name text,
  email text UNIQUE,
  created_at timestamp without time zone DEFAULT now(),
  onboarding_skipped boolean DEFAULT false,
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT users_pkey PRIMARY KEY (id)
);
CREATE TABLE public.value_compass (
  id uuid NOT NULL,
  user_id uuid,
  core_values ARRAY,
  anti_values ARRAY,
  narrative text,
  last_reflected_at timestamp without time zone,
  CONSTRAINT value_compass_pkey PRIMARY KEY (id),
  CONSTRAINT value_compass_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);